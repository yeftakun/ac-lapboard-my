---
import '../styles/globals.css';
import iconUrl from '../icons/icon.png';
import userConfig from '../data/config.json';

const logoIcon = typeof iconUrl === 'string' ? iconUrl : iconUrl.src;
const metaConfig = userConfig?.meta ?? {};
const fallbackSite = Astro.site?.href ?? 'https://example.com';

const siteUrl = (() => {
  const candidate = metaConfig.siteUrl ?? fallbackSite;
  try {
    return new URL(candidate).href;
  } catch {
    return fallbackSite;
  }
})();

const toAbsoluteUrl = (value, base) => {
  if (!value) return new URL('/images/preview.png', base).href;
  try {
    return new URL(value, base).href;
  } catch {
    return value;
  }
};

const defaultTitle = metaConfig.title ?? 'Assetto Corsa Lap Board';
const defaultDescription = metaConfig.description ?? 'Lap time board generated from personalbest.ini and rendered with Astro.';
const defaultOgImage = toAbsoluteUrl(metaConfig.image ?? '/images/preview.png', siteUrl);
const urlPath = Astro.url?.pathname ?? '/';
const title = Astro.props.title ?? defaultTitle;
const description = Astro.props.description ?? defaultDescription;
const image = Astro.props.image ?? defaultOgImage;
const imageAlt = Astro.props.imageAlt ?? 'Lap time preview';
const ogType = Astro.props.ogType ?? 'website';
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={new URL(urlPath, siteUrl).href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={new URL(urlPath, siteUrl).href} />
    <meta property="og:image" content={image} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta name="theme-color" content="#2a5bff" />
    <script is:inline>
      (() => {
        const root = document.documentElement;
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldUseDark = stored ? stored === 'dark' : prefersDark;
        root.classList.toggle('dark', shouldUseDark);
      })();
    </script>
  </head>
  <body class="bg-[var(--bg)] text-[var(--text)]">
    <header class="sticky top-0 z-40 border-b border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_85%,transparent)] backdrop-blur">
      <div class="mx-auto flex max-w-5xl items-center justify-between px-6 py-4">
        <a href="/" class="flex items-center gap-3 font-semibold">
          <img src={logoIcon} alt="Lap Board icon" class="h-11 w-11 object-contain" loading="lazy" decoding="async" />
          <div class="text-sm text-[var(--muted)] leading-tight">
            <span class="block text-[var(--text)] font-semibold">Lap Board</span>
            <span>Assetto Corsa</span>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <button type="button" data-theme-toggle class="btn btn-ghost text-xs uppercase">
            <span class="dark:hidden flex items-center gap-2"><span aria-hidden="true">☾</span>Dark</span>
            <span class="hidden dark:flex items-center gap-2"><span aria-hidden="true">☀</span>Light</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl px-6 py-16 space-y-16">
      <slot />
    </main>

    <footer class="border-t border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_92%,transparent)]">
      <div class="mx-auto flex max-w-5xl flex-col gap-3 px-6 py-8 text-sm text-[var(--muted)] md:flex-row md:items-center md:justify-between">
        <span><i>It’s not about pushing harder, but knowing the limit and holding it.</i></span>
        <div class="flex gap-4 text-xs uppercase tracking-wide">
          <a href="https://github.com/yeftakun/ac-lapboard" target="_blank" rel="noreferrer" class="hover:text-[var(--primary)]">Get the Template</a>
          <button type="button" data-how-it-works class="button-link hover:text-[var(--primary)]" aria-haspopup="dialog">
            HOW IT WORKS
          </button>
        </div>
      </div>
    </footer>

    <div class="how-modal" data-how-modal hidden>
      <div class="how-modal__overlay" data-modal-close aria-hidden="true"></div>
      <div class="how-modal__panel" role="dialog" aria-modal="true" aria-labelledby="how-modal-title" tabindex="-1">
        <div class="how-modal__header">
          <div>
            <p class="text-xs uppercase tracking-wide text-[var(--muted)]">How it works</p>
            <h2 id="how-modal-title" class="text-2xl font-semibold">Quick pipeline</h2>
          </div>
          <button type="button" class="modal-close" data-modal-close aria-label="Close modal">&times;</button>
        </div>
        <p class="text-sm text-[var(--muted)]">It’s basically a short loop that turns the Assetto Corsa lap file into the table you see here.</p>
        <ol class="modal-steps">
          <li><strong>Drop the file.</strong> Copy <code>personalbest.ini</code> into <code>data/</code>; it’s the same file the game updates after every stint.</li>
          <li><strong>Run the converter.</strong> <code>npm run build</code> or <code>npm run laps:convert</code> spins up <code>scripts/convert-personalbest.mjs</code> to tidy up the track, car, and lap info.</li>
          <li><strong>Save the data.</strong> That script writes <code>src/data/laptime.json</code>, so the site has clean JSON to read from.</li>
          <li><strong>Render the table.</strong> Astro imports the JSON and hands it to the React table component, which shows your PBs and gaps.</li>
        </ol>
      </div>
    </div>

    <script is:inline>
      const toggles = document.querySelectorAll('[data-theme-toggle]');
      const root = document.documentElement;
      toggles.forEach((btn) => {
        btn.addEventListener('click', () => {
          const isDark = root.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
      });

      const modal = document.querySelector('[data-how-modal]');
      const openers = document.querySelectorAll('[data-how-it-works]');
      if (modal && openers.length) {
        const dialog = modal.querySelector('[role="dialog"]');
        const setModalState = (open) => {
          modal.hidden = !open;
          document.body.style.overflow = open ? 'hidden' : '';
          if (open) {
            dialog?.focus();
          }
        };

        openers.forEach((button) => {
          button.addEventListener('click', () => setModalState(true));
        });

        modal.querySelectorAll('[data-modal-close]').forEach((closer) => {
          closer.addEventListener('click', () => setModalState(false));
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !modal.hidden) {
            setModalState(false);
          }
        });
      }
    </script>
  </body>
</html>
