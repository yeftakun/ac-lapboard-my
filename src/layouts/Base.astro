---
import '../styles/globals.css';
import iconUrl from '../icons/icon.png';
import userConfig from '../data/config.json';

const logoIcon = typeof iconUrl === 'string' ? iconUrl : iconUrl.src;
const metaConfig = userConfig?.meta ?? {};
const fallbackSite = Astro.site?.href ?? 'https://example.com';

const siteUrl = (() => {
  const candidate = metaConfig.siteUrl ?? fallbackSite;
  try {
    return new URL(candidate).href;
  } catch {
    return fallbackSite;
  }
})();

const toAbsoluteUrl = (value, base) => {
  if (!value) return new URL('/images/preview.png', base).href;
  try {
    return new URL(value, base).href;
  } catch {
    return value;
  }
};

const defaultTitle = metaConfig.title ?? 'Assetto Corsa Lap Board';
const defaultDescription = metaConfig.description ?? 'Lap time board generated from personalbest.ini and rendered with Astro.';
const defaultOgImage = toAbsoluteUrl(metaConfig.image ?? '/images/preview.png', siteUrl);
const urlPath = Astro.url?.pathname ?? '/';
const title = Astro.props.title ?? defaultTitle;
const description = Astro.props.description ?? defaultDescription;
const image = Astro.props.image ?? defaultOgImage;
const imageAlt = Astro.props.imageAlt ?? 'Lap time preview';
const ogType = Astro.props.ogType ?? 'website';
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={new URL(urlPath, siteUrl).href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={new URL(urlPath, siteUrl).href} />
    <meta property="og:image" content={image} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta name="theme-color" content="#2a5bff" />
    <script is:inline>
      (() => {
        const root = document.documentElement;
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldUseDark = stored ? stored === 'dark' : prefersDark;
        root.classList.toggle('dark', shouldUseDark);
      })();
    </script>
  </head>
  <body class="bg-[var(--bg)] text-[var(--text)]">
    <header class="sticky top-0 z-40 border-b border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_85%,transparent)] backdrop-blur">
      <div class="mx-auto flex max-w-5xl items-center justify-between px-6 py-4">
        <a href="/" class="flex items-center gap-3 font-semibold">
          <img src={logoIcon} alt="Lap Board icon" class="h-11 w-11 object-contain" loading="lazy" decoding="async" />
          <div class="text-sm text-[var(--muted)] leading-tight">
            <span class="block text-[var(--text)] font-semibold">Lap Board</span>
            <span>Assetto Corsa</span>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <button type="button" data-theme-toggle class="btn btn-ghost text-xs uppercase">
            <span class="dark:hidden flex items-center gap-2"><span aria-hidden="true">â˜¾</span>Dark</span>
            <span class="hidden dark:flex items-center gap-2"><span aria-hidden="true">â˜€</span>Light</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl px-6 py-16 space-y-16">
      <slot />
    </main>

    <footer class="border-t border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_92%,transparent)]">
      <div class="mx-auto flex max-w-5xl flex-col gap-3 px-6 py-8 text-sm text-[var(--muted)] md:flex-row md:items-center md:justify-between">
        <span><i>Itâ€™s not about pushing harder, but knowing the limit and holding it.</i></span>
        <div class="flex gap-4 text-xs uppercase tracking-wide items-center">
          <a href="https://github.com/yeftakun/ac-lapboard" target="_blank" rel="noreferrer" class="hover:text-[var(--primary)]">Get the Template</a>
          <button type="button" data-how-it-works class="button-link hover:text-[var(--primary)]" aria-haspopup="dialog">
            HOW IT WORKS
          </button>
          <button
            type="button"
            class="info-icon"
            data-about-toggle
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="about-panel"
            title="About this project"
          >
            <span aria-hidden="true">â„¹</span>
            <span class="sr-only">About this project</span>
          </button>
        </div>
      </div>
    </footer>

    <div class="how-modal" data-how-modal hidden>
      <div class="how-modal__overlay" data-modal-close aria-hidden="true"></div>
      <div class="how-modal__panel" role="dialog" aria-modal="true" aria-labelledby="how-modal-title" tabindex="-1">
        <div class="how-modal__header">
          <div>
            <p class="text-xs uppercase tracking-wide text-[var(--muted)]">How it works</p>
            <h2 id="how-modal-title" class="text-2xl font-semibold">Quick pipeline</h2>
          </div>
          <button type="button" class="modal-close" data-modal-close aria-label="Close modal">&times;</button>
        </div>
        <p class="text-sm text-[var(--muted)]">Itâ€™s basically a short loop that turns the Assetto Corsa lap file into the table you see here.</p>
        <ol class="modal-steps">
          <li><strong>Drop the file.</strong> Copy <code>personalbest.ini</code> into <code>data/</code>; itâ€™s the same file the game updates after every stint.</li>
          <li><strong>Run the converter.</strong> <code>npm run build</code> or <code>npm run laps:convert</code> spins up <code>scripts/convert-personalbest.mjs</code> to tidy up the track, car, and lap info.</li>
          <li><strong>Save the data.</strong> That script writes <code>src/data/laptime.json</code>, so the site has clean JSON to read from.</li>
          <li><strong>Render the table.</strong> Astro imports the JSON and hands it to the React table component, which shows your PBs and gaps.</li>
        </ol>
      </div>
    </div>

    <section class="about-panel" data-about-panel id="about-panel" hidden tabindex="-1" aria-label="Project information">
      <button type="button" class="about-panel__close" data-about-close aria-label="Close about panel">&times;</button>
      <p class="about-panel__hint">Stack</p>
      <div class="about-panel__stack" role="list">
        <button type="button" class="stack-icon stack-icon--astro" aria-label="Astro" title="Astro" role="listitem">
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <path fill="#ff5f40" d="M37.6 4.1 54.9 52H44.5L38 36.8H26L19.5 52H9.1L26.4 4.1A2.3 2.3 0 0 1 28.5 2h7a2.3 2.3 0 0 1 2.1 2.1Z" />
            <path fill="#0f172a" d="m24 44 8-22 8 22z" />
          </svg>
        </button>
        <button type="button" class="stack-icon stack-icon--react" aria-label="React" title="React" role="listitem">
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <g stroke="#61dafb" stroke-width="3" stroke-linecap="round">
              <ellipse cx="32" cy="32" rx="20" ry="9" />
              <ellipse cx="32" cy="32" rx="20" ry="9" transform="rotate(60 32 32)" />
              <ellipse cx="32" cy="32" rx="20" ry="9" transform="rotate(120 32 32)" />
              <circle fill="#61dafb" cx="32" cy="32" r="4" stroke="none" />
            </g>
          </svg>
        </button>
        <button type="button" class="stack-icon stack-icon--tailwind" aria-label="Tailwind CSS" title="Tailwind CSS" role="listitem">
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <path fill="#38bdf8" d="M32 14c-9 0-13.8 4.8-14.3 14.3 2.9-4.3 6.3-5.9 10.1-4.9 2.2.6 3.8 2.2 5.6 4.1 2.7 2.7 5.9 5.9 12.9 5.9 9 0 13.8-4.8 14.3-14.3-2.9 4.3-6.3 6-10.1 4.9-2.2-.6-3.8-2.2-5.6-4.1C41.2 17.2 38 14 32 14Zm-14.3 18C15 36.3 11.6 38 7.8 37c-2.2-.6-3.8-2.2-5.6-4.1C-.5 30.2-3.7 27-10.7 27c-9 0-13.8 4.8-14.3 14.3 2.9-4.3 6.3-6 10.1-4.9 2.2.6 3.8 2.2 5.6 4.1 2.7 2.7 5.9 5.9 12.9 5.9 9 0 13.8-4.8 14.3-14.4Z" transform="translate(22 6)" />
          </svg>
        </button>
        <button type="button" class="stack-icon stack-icon--vite" aria-label="Vite" title="Vite" role="listitem">
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <defs>
              <linearGradient id="vitePurple" x1="32" y1="6" x2="32" y2="58" gradientUnits="userSpaceOnUse">
                <stop stop-color="#a855f7" />
                <stop offset="1" stop-color="#7c3aed" />
              </linearGradient>
              <linearGradient id="viteYellow" x1="32" y1="8" x2="32" y2="46" gradientUnits="userSpaceOnUse">
                <stop stop-color="#facc15" />
                <stop offset="1" stop-color="#f97316" />
              </linearGradient>
            </defs>
            <path fill="url(#vitePurple)" d="M8 10.5 32 58l24-47.5L34.4 6h-4.8z" />
            <path fill="url(#viteYellow)" d="M26 8 32.1 34 38 8h-4.4L32 16l-1.6-8z" />
          </svg>
        </button>
      </div>
      <p class="about-panel__thanks">Thanks to <strong>GPT-5.1-Codex</strong> <span class="about-panel__note">(vibe code dawgðŸ¥€)</span></p>
      <p class="about-panel__author">
        Author <a href="https://github.com/yeftakun" target="_blank" rel="noreferrer">@yeftakun</a>
      </p>
    </section>

    <button type="button" class="back-to-top" data-back-to-top aria-label="Back to top" hidden>
      <span aria-hidden="true">â†‘</span>
    </button>

    <script is:inline>
      const toggles = document.querySelectorAll('[data-theme-toggle]');
      const root = document.documentElement;
      toggles.forEach((btn) => {
        btn.addEventListener('click', () => {
          const isDark = root.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
      });

      const modal = document.querySelector('[data-how-modal]');
      const openers = document.querySelectorAll('[data-how-it-works]');
      if (modal && openers.length) {
        const dialog = modal.querySelector('[role="dialog"]');
        const setModalState = (open) => {
          modal.hidden = !open;
          document.body.style.overflow = open ? 'hidden' : '';
          if (open) {
            dialog?.focus();
          }
        };

        openers.forEach((button) => {
          button.addEventListener('click', () => setModalState(true));
        });

        modal.querySelectorAll('[data-modal-close]').forEach((closer) => {
          closer.addEventListener('click', () => setModalState(false));
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && !modal.hidden) {
            setModalState(false);
          }
        });
      }

      const aboutToggle = document.querySelector('[data-about-toggle]');
      const aboutPanel = document.querySelector('[data-about-panel]');
      if (aboutToggle && aboutPanel) {
        const closeAbout = aboutPanel.querySelector('[data-about-close]');
        const setAboutState = (open) => {
          aboutPanel.hidden = !open;
          aboutToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          if (open) {
            aboutPanel.focus();
          }
        };

        aboutToggle.addEventListener('click', (event) => {
          event.stopPropagation();
          const nextState = aboutToggle.getAttribute('aria-expanded') !== 'true';
          setAboutState(nextState);
        });

        closeAbout?.addEventListener('click', () => setAboutState(false));

        document.addEventListener('click', (event) => {
          if (aboutPanel.hidden) return;
          const clickedToggle = aboutToggle.contains(event.target);
          if (!aboutPanel.contains(event.target) && !clickedToggle) {
            setAboutState(false);
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && aboutToggle.getAttribute('aria-expanded') === 'true') {
            setAboutState(false);
          }
        });
      }

      const backToTop = document.querySelector('[data-back-to-top]');
      if (backToTop) {
        const toggleBackToTop = () => {
          const shouldShow = window.scrollY > 320;
          backToTop.hidden = !shouldShow;
        };

        toggleBackToTop();
        window.addEventListener('scroll', toggleBackToTop, { passive: true });
        backToTop.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
    </script>
  </body>
</html>
