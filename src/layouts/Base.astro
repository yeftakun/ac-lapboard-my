---
import '../styles/globals.css';
import iconUrl from '../icons/icon.png';
import userConfig from '../data/config.json';

const logoIcon = typeof iconUrl === 'string' ? iconUrl : iconUrl.src;
const metaConfig = userConfig?.meta ?? {};
const fallbackSite = Astro.site?.href ?? 'https://example.com';

const siteUrl = (() => {
  const candidate = metaConfig.siteUrl ?? fallbackSite;
  try {
    return new URL(candidate).href;
  } catch {
    return fallbackSite;
  }
})();

const toAbsoluteUrl = (value, base) => {
  if (!value) return new URL('/images/preview.png', base).href;
  try {
    return new URL(value, base).href;
  } catch {
    return value;
  }
};

const defaultTitle = metaConfig.title ?? 'Assetto Corsa Lap Board';
const defaultDescription = metaConfig.description ?? 'Lap time board generated from personalbest.ini and rendered with Astro.';
const defaultOgImage = toAbsoluteUrl(metaConfig.image ?? '/images/preview.png', siteUrl);
const urlPath = Astro.url?.pathname ?? '/';
const title = Astro.props.title ?? defaultTitle;
const description = Astro.props.description ?? defaultDescription;
const image = Astro.props.image ?? defaultOgImage;
const imageAlt = Astro.props.imageAlt ?? 'Lap time preview';
const ogType = Astro.props.ogType ?? 'website';
---
<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={new URL(urlPath, siteUrl).href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={new URL(urlPath, siteUrl).href} />
    <meta property="og:image" content={image} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta name="theme-color" content="#2a5bff" />
    <script is:inline>
      (() => {
        const root = document.documentElement;
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldUseDark = stored ? stored === 'dark' : prefersDark;
        root.classList.toggle('dark', shouldUseDark);
      })();
    </script>
  </head>
  <body class="bg-[var(--bg)] text-[var(--text)]">
    <header class="sticky top-0 z-40 border-b border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_85%,transparent)] backdrop-blur">
      <div class="mx-auto flex max-w-5xl items-center justify-between px-6 py-4">
        <a href="/" class="flex items-center gap-3 font-semibold">
          <img src={logoIcon} alt="Lap Board icon" class="h-11 w-11 object-contain" loading="lazy" decoding="async" />
          <div class="text-sm text-[var(--muted)] leading-tight">
            <span class="block text-[var(--text)] font-semibold">Lap Board</span>
            <span>Assetto Corsa</span>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <button type="button" data-theme-toggle class="btn btn-ghost text-xs uppercase">
            <span class="dark:hidden flex items-center gap-2"><span aria-hidden="true">☾</span>Dark</span>
            <span class="hidden dark:flex items-center gap-2"><span aria-hidden="true">☀</span>Light</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl px-6 py-16 space-y-16">
      <slot />
    </main>

    <footer class="border-t border-[var(--border)] bg-[color-mix(in_srgb,var(--bg)_92%,transparent)]">
      <div class="mx-auto flex max-w-5xl flex-col gap-3 px-6 py-8 text-sm text-[var(--muted)] md:flex-row md:items-center md:justify-between">
        <span>Built with Astro + React · Data from personalbest.ini</span>
        <div class="flex gap-4 text-xs uppercase tracking-wide">
          <a href="https://github.com/yeftakun/my-site" target="_blank" rel="noreferrer" class="hover:text-[var(--primary)]">Referensi</a>
          <a href="https://assetto-db.com/" target="_blank" rel="noreferrer" class="hover:text-[var(--primary)]">Assetto DB</a>
        </div>
      </div>
    </footer>

    <script is:inline>
      const toggles = document.querySelectorAll('[data-theme-toggle]');
      const root = document.documentElement;
      toggles.forEach((btn) => {
        btn.addEventListener('click', () => {
          const isDark = root.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
      });
    </script>
  </body>
</html>
