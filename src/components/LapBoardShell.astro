---
import fs from 'fs';
import path from 'path';
import LapTable from './LapTable.jsx';
import laps from '../data/laptime.json';
import userConfig from '../data/config.json';

const driverProfile = userConfig?.driverProfile ?? null;
const metaConfig = userConfig?.meta ?? {};

const heroDefaults = {
  title: metaConfig.title ?? 'Assetto Corsa Lap Time Board',
  description:
    metaConfig.description ??
    'Drop your personalbest.ini straight from Assetto Corsa, run npm run build, and the table refreshes automatically. Styling mirrors the reference personal site.',
};

const hero = { ...heroDefaults, ...(Astro.props.hero ?? {}) };
const gearLabels = {
  'wheel-pedal': 'Wheel & Pedal',
  gamepad: 'Gamepad',
  'keyboard-mouse': 'Keyboard & Mouse',
};
const gearKey = driverProfile?.gear?.toLowerCase();
const gearLabel = gearKey ? gearLabels[gearKey] ?? driverProfile?.gear : null;

const lapCount = laps.length;
const trackCount = new Set(laps.map((lap) => lap.track)).size;
const carCount = new Set(laps.map((lap) => lap.car)).size;

const normalizeName = (value = '') =>
  value
    .replace(/^KS[_-]?/i, '')
    .replace(/[_-]+/g, ' ')
    .trim()
    .toLowerCase();

const featuredConfig = userConfig?.featuredLap ?? { show: false };
const featuredLap = featuredConfig.show
  ? laps.find(
      (lap) =>
        normalizeName(lap.track) === normalizeName(featuredConfig.track ?? '') &&
        normalizeName(lap.car) === normalizeName(featuredConfig.car ?? ''),
    )
  : null;

const personalBestPath = path.resolve('data/personalbest.ini');
const humanReadableLastDate = (() => {
  try {
    const stats = fs.statSync(personalBestPath);
    return new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(stats.mtime);
  } catch {
    const lastDate = laps.reduce((latest, lap) => (latest > lap.date ? latest : lap.date), laps[0]?.date ?? null);
    return lastDate ? new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format(new Date(lastDate)) : '—';
  }
})();
---
<section class="space-y-6">
  <div class="space-y-4">
    <h1 class="text-4xl font-semibold leading-tight">{hero.title}</h1>
    <p class="max-w-2xl text-lg text-[var(--muted)]">{hero.description}</p>
    {driverProfile && (
      <div class="driver-meta">
        <div>
          <p class="text-xs uppercase tracking-wide text-[var(--muted)]">Driver</p>
          <p class="text-lg font-semibold">{driverProfile.name}</p>
        </div>
        <div class="driver-meta__chips">
          {gearLabel && (
            <span class="gear-badge" data-gear={gearKey}>{gearLabel}</span>
          )}
          {driverProfile.featuredLink?.url && (
            <a
              href={driverProfile.featuredLink.url}
              target="_blank"
              rel="noreferrer"
              class="driver-link"
            >
              <span>{driverProfile.featuredLink.label ?? 'Profile'}</span>
            </a>
          )}
        </div>
      </div>
    )}
  </div>
  <div class="stat-grid">
    <div class="stat-card">
      <p class="text-sm text-[var(--muted)] uppercase tracking-wide">Total Laps</p>
      <p class="stat-value">{lapCount}</p>
      <p class="text-xs text-[var(--muted)]">Pulled from personalbest.ini</p>
    </div>
    <div class="stat-card">
      <p class="text-sm text-[var(--muted)] uppercase tracking-wide">Tracks</p>
      <p class="stat-value">{trackCount}</p>
      <p class="text-xs text-[var(--muted)]">Unique layouts logged</p>
    </div>
    <div class="stat-card">
      <p class="text-sm text-[var(--muted)] uppercase tracking-wide">Cars</p>
      <p class="stat-value">{carCount}</p>
      <p class="text-xs text-[var(--muted)]">Different cars</p>
    </div>
    {featuredConfig.show && (
      <div class="stat-card border-[var(--primary)]">
        <p class="text-sm text-[var(--muted)] uppercase tracking-wide">Featured Lap</p>
        {featuredLap ? (
          <>
            <p class="stat-value text-[var(--primary)]">{featuredLap.laptime_display}</p>
            <p class="text-xs text-[var(--muted)]">{featuredLap.track} · {featuredLap.car}</p>
            {featuredConfig.note && <p class="text-xs text-[var(--muted)]">{featuredConfig.note}</p>}
          </>
        ) : (
          <p class="text-xs text-[var(--muted)]">Lap not found, double-check config.json.</p>
        )}
      </div>
    )}
  </div>
</section>

<section class="space-y-6">
  <header>
    <p class="text-sm text-[var(--muted)]">Last updated: {humanReadableLastDate}</p>
  </header>
  <LapTable rows={laps} client:load />
</section>
